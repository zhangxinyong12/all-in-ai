# å‘é‡æ•°æ®åº“è¯¦è§£ - é¢å‘ ORM å¼€å‘è€…

> ä» ORM åˆ°å‘é‡ï¼šç”¨ä½ ç†Ÿæ‚‰çš„æ•°æ®åº“æ¦‚å¿µç†è§£å‘é‡æ•°æ®åº“

---

## ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦å‘é‡æ•°æ®åº“ï¼Ÿ

### 1.1 ä¼ ç»Ÿæ•°æ®åº“çš„å±€é™

ä½ ç†Ÿæ‚‰çš„ ORM æ“ä½œæ˜¯è¿™æ ·çš„ï¼š

```typescript
// Prisma / TypeORM æŸ¥è¯¢
const users = await prisma.user.findMany({
  where: {
    name: { contains: 'å¼ ' },
    age: { gte: 18 },
  },
});
```

**é—®é¢˜ï¼š** è¿™ç±»æŸ¥è¯¢æ˜¯**ç²¾ç¡®åŒ¹é…**æˆ–**æ¨¡ç³ŠåŒ¹é…**

---

ä½†å¤§æ¨¡å‹æ—¶ä»£ï¼Œæˆ‘ä»¬éœ€è¦çš„æ˜¯**è¯­ä¹‰åŒ¹é…**ï¼š

```
ä¼ ç»ŸæŸ¥è¯¢ï¼š
æœç´¢ "è‹¹æœ" â†’ åªèƒ½æ‰¾åˆ°åŒ…å«"è‹¹æœ"çš„æ–‡æ¡£
æœç´¢ "çº¢è‰²çš„æ°´æœ" â†’ æ‰¾ä¸åˆ°"è‹¹æœ"

è¯­ä¹‰æœç´¢ï¼š
æœç´¢ "çº¢è‰²çš„æ°´æœ" â†’ èƒ½æ‰¾åˆ°"è‹¹æœ"ã€"è‰è“"ã€"æ¨±æ¡ƒ"
æœç´¢ "ç§‘æŠ€å…¬å¸" â†’ èƒ½æ‰¾åˆ°"è‹¹æœå…¬å¸"ã€"å¾®è½¯"ã€"è°·æ­Œ"
```

**è¿™å°±æ˜¯å‘é‡æ•°æ®åº“è§£å†³çš„é—®é¢˜ï¼šè®©æœºå™¨ç†è§£è¯­ä¹‰ï¼**

---

### 1.2 å¯¹æ¯”ç¤ºä¾‹

| æŸ¥è¯¢ç±»å‹ | ä¼ ç»Ÿæ•°æ®åº“                    | å‘é‡æ•°æ®åº“              |
| -------- | ----------------------------- | ----------------------- |
| ç²¾ç¡®åŒ¹é… | âœ… `WHERE name = 'è‹¹æœ'`      | âŒ ä¸æ”¯æŒ               |
| æ¨¡ç³ŠåŒ¹é… | âœ… `WHERE name LIKE '%è‹¹æœ%'` | âŒ ä¸æ”¯æŒ               |
| è¯­ä¹‰åŒ¹é… | âŒ æ— æ³•åšåˆ°                   | âœ… æœç´¢"æ°´æœ"æ‰¾åˆ°"è‹¹æœ" |
| ç›¸ä¼¼åº¦   | âŒ éœ€è¦å¤æ‚çš„ç®—æ³•             | âœ… å¤©ç„¶æ”¯æŒ             |

---

## äºŒã€æ ¸å¿ƒæ¦‚å¿µï¼šç”¨ ORM ç†è§£å‘é‡

### 2.1 å‘é‡æ˜¯ä»€ä¹ˆï¼Ÿ

**ç®€å•ç†è§£ï¼šå‘é‡å°±æ˜¯æ•°å­—åˆ—è¡¨**

```typescript
// ä¼ ç»Ÿæ•°æ®
const user = {
  name: 'å¼ ä¸‰',
  age: 25
}

// å‘é‡æ•°æ®ï¼ˆæ¦‚å¿µä¸Šçš„å¯¹æ¯”ï¼‰
const vector = [0.1, -0.2, 0.8, 0.3, ...]
//              â†‘   â†‘   â†‘   â†‘
//              æ¯ä¸ªæ•°å­—ä»£è¡¨ä¸€ä¸ª"ç‰¹å¾"
```

**å‘é‡çš„æ„ä¹‰ï¼š**

- `0.8` å¯èƒ½ä»£è¡¨"æ°´æœ"è¿™ä¸ªç‰¹å¾
- `-0.2` å¯èƒ½ä»£è¡¨"ç”µå­äº§å“"è¿™ä¸ªç‰¹å¾
- é€šè¿‡è¿™äº›æ•°å­—ï¼Œæœºå™¨èƒ½ç†è§£è¯­ä¹‰

---

### 2.2 Embeddingï¼ˆå‘é‡åŒ–ï¼‰

**Embedding = æŠŠæ–‡æœ¬è½¬æ¢æˆå‘é‡**

```typescript
// æ–‡æœ¬
const text = 'è‹¹æœæ˜¯ä¸€ç§çº¢è‰²çš„æ°´æœ';

// å‘é‡åŒ–ï¼ˆç”¨å¤§æ¨¡å‹APIï¼‰
const vector = await openai.embeddings.create({
  model: 'text-embedding-3-small',
  input: text,
});

// å¾—åˆ°å‘é‡
// [0.123, -0.456, 0.789, ...]  (é€šå¸¸æœ‰1536ä¸ªæ•°å­—)
```

**ç±»æ¯”ç†è§£ï¼š**

| æ¦‚å¿µ     | ä¼ ç»Ÿæ•°æ®åº“    | å‘é‡æ•°æ®åº“          |
| -------- | ------------- | ------------------- |
| å­˜å‚¨å†…å®¹ | æ–‡æœ¬ã€æ•°å­—    | å‘é‡ï¼ˆæ•°å­—åˆ—è¡¨ï¼‰    |
| å­˜å‚¨æ–¹å¼ | ç›´æ¥å­˜å‚¨      | å…ˆ Embedding å†å­˜å‚¨ |
| ç´¢å¼•ç±»å‹ | B-Treeã€Hash  | HNSWã€IVF           |
| æŸ¥è¯¢æ–¹å¼ | ç²¾ç¡®/æ¨¡ç³ŠåŒ¹é… | ç›¸ä¼¼åº¦æœç´¢          |

---

### 2.3 å‘é‡ç›¸ä¼¼åº¦

**æ€ä¹ˆçŸ¥é“ä¸¤ä¸ªå‘é‡æ˜¯å¦ç›¸ä¼¼ï¼Ÿ**

```typescript
// ä¸¤ä¸ªå‘é‡
const v1 = [0.8, 0.2, 0.1]; // ä»£è¡¨"è‹¹æœ"
const v2 = [0.7, 0.3, 0.2]; // ä»£è¡¨"é¦™è•‰"
const v3 = [-0.5, 0.8, 0.9]; // ä»£è¡¨"æ±½è½¦"

// è®¡ç®—ç›¸ä¼¼åº¦ï¼ˆä½™å¼¦ç›¸ä¼¼åº¦ï¼‰
similarity(v1, v2) = 0.95; // å¾ˆç›¸ä¼¼ï¼ˆéƒ½æ˜¯æ°´æœï¼‰
similarity(v1, v3) = 0.12; // ä¸ç›¸ä¼¼ï¼ˆæ°´æœ vs æ±½è½¦ï¼‰
```

**ç±»æ¯”ç†è§£ï¼š**

```
ä¼ ç»Ÿæ•°æ®åº“ï¼šè®¡ç®—ä¸¤ä¸ªå­—ç¬¦ä¸²çš„ç›¸ä¼¼åº¦
SELECT * FROM users
WHERE similarity(name, 'å¼ ä¸‰') > 0.8

å‘é‡æ•°æ®åº“ï¼šè®¡ç®—ä¸¤ä¸ªå‘é‡çš„ç›¸ä¼¼åº¦
SELECT * FROM documents
WHERE similarity(vector, query_vector) > 0.8
```

---

## ä¸‰ã€å‘é‡æ•°æ®åº“ vs ä¼ ç»Ÿæ•°æ®åº“

### 3.1 æ¶æ„å¯¹æ¯”

**ä¼ ç»Ÿæ•°æ®åº“ï¼ˆPostgreSQL + Prismaï¼‰**

```typescript
// Schema
model Document {
  id        Int      @id @default(autoincrement())
  title     String
  content   String
  createdAt DateTime @default(now())
}

// æŸ¥è¯¢
const docs = await prisma.document.findMany({
  where: {
    title: { contains: keyword }
  }
})
```

**å‘é‡æ•°æ®åº“ï¼ˆChromaDBï¼‰**

```typescript
// å­˜å‚¨
await chroma.add({
  ids: ['doc1'],
  embeddings: [[0.1, 0.2, 0.3, ...]], // å‘é‡
  metadatas: { title: 'æ–‡æ¡£1', category: 'æŠ€æœ¯' },
  documents: ['è¿™æ˜¯æ–‡æ¡£çš„å†…å®¹']
})

// æŸ¥è¯¢
const results = await chroma.query({
  queryEmbeddings: [[0.15, 0.18, 0.25, ...]], // æŸ¥è¯¢å‘é‡
  nResults: 5
})
```

---

### 3.2 æ•°æ®ç»“æ„å¯¹æ¯”

| ç‰¹æ€§ | ä¼ ç»Ÿæ•°æ®åº“          | å‘é‡æ•°æ®åº“                 |
| ---- | ------------------- | -------------------------- |
| ä¸»é”® | `id`                | `ids`                      |
| æ•°æ® | `name`, `age`       | `embeddings` + `metadatas` |
| ç´¢å¼• | B-Tree              | HNSWï¼ˆå‘é‡ç´¢å¼•ï¼‰           |
| æŸ¥è¯¢ | `WHERE`, `ORDER BY` | `query()` + ç›¸ä¼¼åº¦         |

---

## å››ã€å‘é‡æ•°æ®åº“æ ¸å¿ƒæ“ä½œ

### 4.1 CRUD æ“ä½œï¼ˆç±»æ¯” ORMï¼‰

**ä¼ ç»Ÿ ORM æ“ä½œï¼š**

```typescript
// Create
await prisma.user.create({
  data: { name: 'å¼ ä¸‰', age: 25 },
});

// Read
const users = await prisma.user.findMany({
  where: { age: { gte: 18 } },
});

// Update
await prisma.user.update({
  where: { id: 1 },
  data: { age: 26 },
});

// Delete
await prisma.user.delete({
  where: { id: 1 },
});
```

**å‘é‡æ•°æ®åº“æ“ä½œï¼š**

```typescript
import { ChromaClient } from 'chromadb'

const client = new ChromaClient()

// Createï¼ˆæ·»åŠ æ–‡æ¡£ï¼‰
await client.add({
  ids: ['doc1', 'doc2'],
  embeddings: [
    [0.1, 0.2, 0.3, ...], // doc1çš„å‘é‡
    [0.4, 0.5, 0.6, ...]  // doc2çš„å‘é‡
  ],
  metadatas: [
    { title: 'æ–‡æ¡£1', category: 'æŠ€æœ¯' },
    { title: 'æ–‡æ¡£2', category: 'ç”Ÿæ´»' }
  ],
  documents: ['æ–‡æ¡£1çš„å†…å®¹', 'æ–‡æ¡£2çš„å†…å®¹']
})

// Readï¼ˆæŸ¥è¯¢ç›¸ä¼¼æ–‡æ¡£ï¼‰
const results = await client.query({
  queryEmbeddings: [[0.15, 0.25, 0.35, ...]], // æŸ¥è¯¢å‘é‡
  nResults: 3,
  where: { category: 'æŠ€æœ¯' } // å…ƒæ•°æ®è¿‡æ»¤
})

// Update
await client.update({
  ids: ['doc1'],
  metadatas: { title: 'æ›´æ–°åçš„æ ‡é¢˜' }
})

// Delete
await client.delete({
  ids: ['doc1']
})
```

---

### 4.2 ç›¸ä¼¼åº¦æœç´¢

**ä¼ ç»Ÿæ•°æ®åº“ï¼šæ¨¡ç³Šæœç´¢**

```typescript
// æ‰¾åˆ°åŒ…å«"è‹¹æœ"çš„æ–‡æ¡£
const docs = await prisma.document.findMany({
  where: {
    content: { contains: 'è‹¹æœ' },
  },
});
```

**å‘é‡æ•°æ®åº“ï¼šè¯­ä¹‰æœç´¢**

```typescript
// 1. æŠŠç”¨æˆ·é—®é¢˜è½¬æ¢æˆå‘é‡
const query = 'çº¢è‰²æ°´æœ';
const embedding = await openai.embeddings.create({
  input: query,
  model: 'text-embedding-3-small',
});
const queryVector = embedding.data[0].embedding;

// 2. æœç´¢æœ€ç›¸ä¼¼çš„æ–‡æ¡£
const results = await chroma.query({
  queryEmbeddings: [queryVector],
  nResults: 5,
});

// 3. ç»“æœæŒ‰ç›¸ä¼¼åº¦æ’åº
results.documents[0]; // æœ€ç›¸ä¼¼ï¼ˆå¯èƒ½æ˜¯"è‹¹æœ"ï¼‰
results.documents[1]; // ç¬¬äºŒç›¸ä¼¼ï¼ˆå¯èƒ½æ˜¯"è‰è“"ï¼‰
results.documents[2]; // ç¬¬ä¸‰ç›¸ä¼¼ï¼ˆå¯èƒ½æ˜¯"æ¨±æ¡ƒ"ï¼‰
```

---

## äº”ã€RAGï¼šå‘é‡æ•°æ®åº“çš„å®é™…åº”ç”¨

### 5.1 RAG åŸç†

**RAG = Retrieval Augmented Generationï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰**

```
ç”¨æˆ·é—®é¢˜ â†’ å‘é‡åŒ– â†’ å‘é‡æ•°æ®åº“æ£€ç´¢ â†’ ç›¸å…³æ–‡æ¡£ â†’ LLMç”Ÿæˆç­”æ¡ˆ
```

---

### 5.2 å®Œæ•´æµç¨‹ï¼ˆNode.js å®ç°ï¼‰

```typescript
import { OpenAI } from 'openai';
import { ChromaClient } from 'chromadb';

const openai = new OpenAI();
const chroma = new ChromaClient();

// æ­¥éª¤1ï¼šå‡†å¤‡æ–‡æ¡£å¹¶å­˜å‚¨
async function indexDocuments(documents: string[]) {
  for (const doc of documents) {
    // 1.1 ç”Ÿæˆå‘é‡
    const embedding = await openai.embeddings.create({
      input: doc,
      model: 'text-embedding-3-small',
    });

    // 1.2 å­˜å‚¨åˆ°å‘é‡æ•°æ®åº“
    await chroma.add({
      ids: [`doc_${Date.now()}`],
      embeddings: [embedding.data[0].embedding],
      documents: [doc],
    });
  }
}

// æ­¥éª¤2ï¼šç”¨æˆ·æŸ¥è¯¢
async function queryRAG(question: string) {
  // 2.1 é—®é¢˜å‘é‡åŒ–
  const embedding = await openai.embeddings.create({
    input: question,
    model: 'text-embedding-3-small',
  });

  // 2.2 ä»å‘é‡æ•°æ®åº“æ£€ç´¢ç›¸å…³æ–‡æ¡£
  const results = await chroma.query({
    queryEmbeddings: [embedding.data[0].embedding],
    nResults: 3,
  });

  const context = results.documents[0].join('\n');

  // 2.3 ä½¿ç”¨æ£€ç´¢åˆ°çš„æ–‡æ¡£å›ç­”é—®é¢˜
  const response = await openai.chat.completions.create({
    model: 'gpt-4',
    messages: [
      {
        role: 'system',
        content: 'ä½ æ˜¯ä¸€ä¸ªé—®ç­”åŠ©æ‰‹ï¼Œè¯·æ ¹æ®ä»¥ä¸‹æ–‡æ¡£å›ç­”ç”¨æˆ·é—®é¢˜',
      },
      {
        role: 'user',
        content: `æ–‡æ¡£å†…å®¹ï¼š\n${context}\n\nç”¨æˆ·é—®é¢˜ï¼š${question}`,
      },
    ],
  });

  return response.choices[0].message.content;
}

// ä½¿ç”¨
await indexDocuments([
  'è‹¹æœæ˜¯ä¸€ç§çº¢è‰²çš„æ°´æœï¼Œå¯Œå«ç»´ç”Ÿç´ C',
  'é¦™è•‰æ˜¯ä¸€ç§é»„è‰²çš„æ°´æœï¼Œå¯Œå«é’¾å…ƒç´ ',
  'è‰è“æ˜¯ä¸€ç§çº¢è‰²çš„æµ†æœï¼Œå‘³é“é…¸ç”œ',
]);

const answer = await queryRAG('çº¢è‰²çš„æ°´æœæœ‰å“ªäº›ï¼Ÿ');
// å›ç­”ï¼šæ ¹æ®æ–‡æ¡£ï¼Œçº¢è‰²çš„æ°´æœæœ‰è‹¹æœå’Œè‰è“
```

---

### 5.3 ä¸ä¼ ç»Ÿæ•°æ®åº“ç»“åˆ

**æœ€ä½³å®è·µï¼šä¼ ç»Ÿæ•°æ®åº“ + å‘é‡æ•°æ®åº“**

```typescript
// 1. ä¼ ç»Ÿæ•°æ®åº“å­˜å‚¨åŸå§‹æ–‡æ¡£
await prisma.document.create({
  data: {
    id: 'doc1',
    title: 'è‹¹æœ',
    content: 'è‹¹æœæ˜¯ä¸€ç§çº¢è‰²çš„æ°´æœ',
    category: 'æ°´æœ'
  }
})

// 2. å‘é‡æ•°æ®åº“å­˜å‚¨å‘é‡ï¼ˆå…³è”ä¼ ç»Ÿæ•°æ®åº“IDï¼‰
await chroma.add({
  ids: ['doc1'],
  embeddings: [[0.1, 0.2, 0.3, ...]],
  metadatas: { docId: 'doc1' }
})

// 3. æŸ¥è¯¢æ—¶ç»“åˆä¸¤è€…
async function hybridSearch(question: string) {
  // 3.1 å‘é‡æœç´¢
  const vectorResults = await chroma.query({
    queryEmbeddings: [queryVector],
    nResults: 5
  })

  const docIds = vectorResults.ids[0]

  // 3.2 ä»ä¼ ç»Ÿæ•°æ®åº“è·å–å®Œæ•´ä¿¡æ¯
  const documents = await prisma.document.findMany({
    where: {
      id: { in: docIds }
    }
  })

  return documents
}
```

---

## å…­ã€ä¸»æµå‘é‡æ•°æ®åº“

### 6.1 å¯¹æ¯”è¡¨

| æ•°æ®åº“       | è¯­è¨€      | ç‰¹ç‚¹             | é€‚ç”¨åœºæ™¯           |
| ------------ | --------- | ---------------- | ------------------ |
| **ChromaDB** | Python/JS | è½»é‡ã€æ˜“ç”¨       | ä¸ªäººé¡¹ç›®ã€å¿«é€ŸåŸå‹ |
| **Pinecone** | äº‘æœåŠ¡    | æ‰˜ç®¡æœåŠ¡ã€é«˜æ€§èƒ½ | ç”Ÿäº§ç¯å¢ƒã€ä¼ä¸šçº§   |
| **Milvus**   | Go        | å¼€æºã€åŠŸèƒ½å…¨     | å¤§è§„æ¨¡æ•°æ®         |
| **Qdrant**   | Rust      | é«˜æ€§èƒ½ã€æ˜“éƒ¨ç½²   | ç”Ÿäº§ç¯å¢ƒ           |
| **Weaviate** | Go        | å¤šæ¨¡æ€ã€GraphQL  | å¤æ‚æŸ¥è¯¢           |

---

### 6.2 æ¨èé€‰æ‹©

**å­¦ä¹ é˜¶æ®µï¼ˆæ¨èï¼‰ï¼šChromaDB**

```typescript
// ä¼˜ç‚¹
- âœ… è½»é‡çº§ï¼Œæœ¬åœ°è¿è¡Œ
- âœ… æ”¯æŒTypeScript
- âœ… æ˜“äºç†è§£å’Œä½¿ç”¨
- âœ… é€‚åˆå¿«é€ŸåŸå‹

// å®‰è£…
npm install chromadb

// ä½¿ç”¨
import { ChromaClient } from 'chromadb'
const client = new ChromaClient()
```

---

**ç”Ÿäº§ç¯å¢ƒï¼šPineconeï¼ˆæ‰˜ç®¡ï¼‰æˆ– Qdrantï¼ˆè‡ªå»ºï¼‰**

```typescript
// Pineconeï¼ˆæ‰˜ç®¡ï¼Œæ— éœ€ç»´æŠ¤ï¼‰
import { PineconeClient } from '@pinecone-database/pinecone';
const client = new PineconeClient();

// Qdrantï¼ˆå¼€æºï¼Œå¯è‡ªå»ºï¼‰
import { QdrantClient } from '@qdrant/js-client-rest';
const client = new QdrantClient({ url: 'http://localhost:6333' });
```

---

## ä¸ƒã€å®é™…åº”ç”¨åœºæ™¯

### 7.1 æ™ºèƒ½æ–‡æ¡£æœç´¢

```typescript
// ä¼ ç»Ÿæœç´¢ï¼šåªèƒ½åŒ¹é…å…³é”®è¯
search('React') â†’ æ‰¾åˆ°åŒ…å«"React"çš„æ–‡æ¡£

// å‘é‡æœç´¢ï¼šç†è§£è¯­ä¹‰
search('å‰ç«¯æ¡†æ¶') â†’ æ‰¾åˆ°Reactã€Vueã€Angularç›¸å…³æ–‡æ¡£
search('ç»„ä»¶åŒ–å¼€å‘') â†’ æ‰¾åˆ°Reactç»„ä»¶æ–‡æ¡£
```

---

### 7.2 ä»£ç æœç´¢

```typescript
// ä¼ ç»Ÿæœç´¢
search('useState') â†’ æ‰¾åˆ°åŒ…å«useStateçš„ä»£ç 

// å‘é‡æœç´¢
search('å¦‚ä½•ç®¡ç†çŠ¶æ€') â†’ æ‰¾åˆ°useStateã€useReducerã€Reduxç­‰ä»£ç 
search('é˜²æŠ–å‡½æ•°') â†’ æ‰¾åˆ°debounceç›¸å…³ä»£ç 
```

---

### 7.3 æ¨èç³»ç»Ÿ

```typescript
// ç”¨æˆ·å†å²è¡Œä¸ºå‘é‡åŒ–
const userVector = await embed(userBehavior);

// å•†å“å‘é‡åŒ–
const productVectors = await embed(allProducts);

// æ‰¾åˆ°æœ€ç›¸ä¼¼çš„å•†å“
const recommendations = await vectorDB.query({
  queryEmbeddings: [userVector],
  nResults: 10,
});
```

---

### 7.4 è¯­ä¹‰é‡å¤æ£€æµ‹

```typescript
// æ£€æµ‹ç›¸ä¼¼å†…å®¹
const doc1 = 'è‹¹æœæ˜¯ä¸€ç§æ°´æœ';
const doc2 = 'è‹¹æœå±äºæ°´æœç±»';

const similarity = cosineSimilarity(await embed(doc1), await embed(doc2));

if (similarity > 0.9) {
  console.log('å†…å®¹é‡å¤');
}
```

---

## å…«ã€å‘é‡æ•°æ®åº“ä¸ä¼ ç»Ÿæ•°æ®åº“çš„èåˆ

### 8.1 PostgreSQL + pgvectorï¼ˆæ¨èï¼‰

**ç›´æ¥åœ¨ PostgreSQL ä¸­ä½¿ç”¨å‘é‡ï¼š**

```sql
-- åˆ›å»ºè¡¨
CREATE TABLE documents (
  id SERIAL PRIMARY KEY,
  content TEXT,
  embedding VECTOR(1536)  -- å‘é‡åˆ—
);

-- æ’å…¥æ•°æ®
INSERT INTO documents (content, embedding)
VALUES (
  'è‹¹æœæ˜¯ä¸€ç§æ°´æœ',
  '[0.1,0.2,0.3,...]'
);

-- ç›¸ä¼¼åº¦æœç´¢
SELECT content, 1 - (embedding <=> '[0.15,0.25,0.35,...]') AS similarity
FROM documents
ORDER BY embedding <=> '[0.15,0.25,0.35,...]'
LIMIT 5;
```

**Prisma æ”¯æŒï¼š**

```prisma
model Document {
  id        Int      @id @default(autoincrement())
  content   String
  embedding Unsupported("VECTOR(1536)")?

  @@index([embedding])
}

// ä½¿ç”¨PrismaæŸ¥è¯¢
const docs = await prisma.$queryRaw`
  SELECT * FROM documents
  ORDER BY embedding <=> ${queryVector}::vector
  LIMIT 5
`
```

---

### 8.2 ä¸ºä»€ä¹ˆæ¨è PostgreSQL + pgvectorï¼Ÿ

| ä¼˜åŠ¿              | è¯´æ˜                         |
| ----------------- | ---------------------------- |
| ğŸ¯ æ— éœ€é¢å¤–æ•°æ®åº“ | å¤ç”¨ç°æœ‰ PostgreSQL          |
| ğŸ’¾ ç»Ÿä¸€æ•°æ®ç®¡ç†   | å‘é‡å’Œç»“æ„åŒ–æ•°æ®åœ¨åŒä¸€æ•°æ®åº“ |
| ğŸš€ äº‹åŠ¡æ”¯æŒ       | ACID ç‰¹æ€§                    |
| ğŸ”— SQL ç†Ÿæ‚‰åº¦é«˜   | ä¸éœ€è¦å­¦ä¹ æ–°æŸ¥è¯¢è¯­è¨€         |
| ğŸ“Š å¯ç»“åˆå…¶ä»–æŸ¥è¯¢ | WHEREã€JOINã€ORDER BY        |

---

## ä¹ã€å­¦ä¹ è·¯å¾„

### ç¬¬ä¸€å‘¨ï¼šåŸºç¡€æ¦‚å¿µ

- ç†è§£å‘é‡å’Œ Embedding
- ç†è§£ç›¸ä¼¼åº¦è®¡ç®—
- å¯¹æ¯”ä¼ ç»Ÿæ•°æ®åº“å’Œå‘é‡æ•°æ®åº“

**å®è·µï¼š**

```typescript
// ä½“éªŒEmbedding
const embedding = await openai.embeddings.create({
  input: 'è‹¹æœ',
  model: 'text-embedding-3-small',
});
console.log(embedding.data[0].embedding);
// è¾“å‡ºï¼š[0.123, -0.456, 0.789, ...]ï¼ˆ1536ä¸ªæ•°å­—ï¼‰
```

---

### ç¬¬äºŒå‘¨ï¼šChromaDB å®è·µ

- å®‰è£… ChromaDB
- å®Œæˆ CRUD æ“ä½œ
- å®ç°ç®€å•æœç´¢

**å®è·µï¼š**

```typescript
// åˆ›å»ºç´¢å¼•
await chroma.add({
  ids: ['1', '2', '3'],
  embeddings: [[...], [...], [...]],
  documents: ['æ–‡æ¡£1', 'æ–‡æ¡£2', 'æ–‡æ¡£3']
})

// æœç´¢
const results = await chroma.query({
  queryEmbeddings: [queryVector],
  nResults: 3
})
```

---

### ç¬¬ä¸‰å‘¨ï¼šRAG ç³»ç»Ÿ

- å®ç°å®Œæ•´çš„ RAG æµç¨‹
- ç»“åˆä¼ ç»Ÿæ•°æ®åº“
- ä¼˜åŒ–æ£€ç´¢æ•ˆæœ

**å®è·µï¼š**

```typescript
// å®Œæ•´RAG
async function ragQuery(question: string) {
  // æ£€ç´¢
  const docs = await chroma.query({ queryEmbeddings: [await embed(question)] });

  // ç”Ÿæˆ
  const answer = await openai.chat.completions.create({
    model: 'gpt-4',
    messages: [
      { role: 'system', content: 'åŸºäºæ–‡æ¡£å›ç­”' },
      { role: 'user', content: `${docs.documents}\n\né—®é¢˜ï¼š${question}` },
    ],
  });

  return answer.choices[0].message.content;
}
```

---

### ç¬¬å››å‘¨ï¼šé¡¹ç›®å®æˆ˜

- æ„å»ºçŸ¥è¯†åº“é—®ç­”ç³»ç»Ÿ
- å®ç°ä»£ç åº“æœç´¢
- ä¼˜åŒ–æ£€ç´¢å‡†ç¡®ç‡

---

## åã€å¸¸è§é—®é¢˜

### Q1: å‘é‡æ•°æ®åº“èƒ½æ›¿ä»£ä¼ ç»Ÿæ•°æ®åº“å—ï¼Ÿ

**A:** ä¸èƒ½ã€‚å‘é‡æ•°æ®åº“æ“…é•¿ç›¸ä¼¼åº¦æœç´¢ï¼Œä½†ä¸é€‚åˆï¼š

- ç²¾ç¡®æŸ¥è¯¢ï¼ˆWHERE id = 1ï¼‰
- å¤æ‚å…³è”æŸ¥è¯¢ï¼ˆJOINï¼‰
- äº‹åŠ¡å¤„ç†

**æœ€ä½³å®è·µï¼š** ä¼ ç»Ÿæ•°æ®åº“ + å‘é‡æ•°æ®åº“é…åˆä½¿ç”¨

---

### Q2: å‘é‡æ•°æ®åº“çš„æ•°æ®ä»å“ªæ¥ï¼Ÿ

**A:** ä»å¤§æ¨¡å‹ API ç”Ÿæˆï¼š

```typescript
const embedding = await openai.embeddings.create({
  input: 'ä½ çš„æ–‡æœ¬',
  model: 'text-embedding-3-small', // æˆ–å…¶ä»–Embeddingæ¨¡å‹
});
```

---

### Q3: Embedding æ¨¡å‹å¦‚ä½•é€‰æ‹©ï¼Ÿ

| æ¨¡å‹                   | ç»´åº¦ | ç‰¹ç‚¹           | ä»·æ ¼            |
| ---------------------- | ---- | -------------- | --------------- |
| text-embedding-3-small | 1536 | å¿«ã€ä¾¿å®œã€å¤Ÿç”¨ | $0.02/1M tokens |
| text-embedding-3-large | 3072 | ç²¾åº¦é«˜ã€æ…¢     | $0.13/1M tokens |
| text-embedding-ada-002 | 1536 | æ—§æ¨¡å‹         | $0.10/1M tokens |

**å»ºè®®ï¼š** å­¦ä¹ é˜¶æ®µç”¨ `text-embedding-3-small`

---

### Q4: å‘é‡æ•°æ®åº“éœ€è¦å¤šå¤§å†…å­˜ï¼Ÿ

**A:** å–å†³äºæ•°æ®é‡ï¼š

```
1ä¸‡æ–‡æ¡£ â‰ˆ 100MB
10ä¸‡æ–‡æ¡£ â‰ˆ 1GB
100ä¸‡æ–‡æ¡£ â‰ˆ 10GB
```

**å­¦ä¹ é˜¶æ®µï¼š** å‡ ç™¾ MB è¶³å¤Ÿ

---

### Q5: æ£€ç´¢å‡†ç¡®ç‡å¦‚ä½•æé«˜ï¼Ÿ

**æ–¹æ³•ï¼š**

1. ä½¿ç”¨æ›´å¥½çš„ Embedding æ¨¡å‹
2. æ·»åŠ é‡æ’åºï¼ˆRerankingï¼‰
3. æ··åˆæ£€ç´¢ï¼ˆå…³é”®è¯ + å‘é‡ï¼‰
4. ä¼˜åŒ–æ–‡æ¡£åˆ‡ç‰‡ç­–ç•¥

---

## åä¸€ã€æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **å‘é‡æ•°æ®åº“ = è¯­ä¹‰æœç´¢æ•°æ®åº“**

   - ä¼ ç»Ÿæ•°æ®åº“ï¼šç²¾ç¡®/æ¨¡ç³ŠåŒ¹é…
   - å‘é‡æ•°æ®åº“ï¼šè¯­ä¹‰ç›¸ä¼¼åº¦åŒ¹é…

2. **Embedding = æ–‡æœ¬è½¬å‘é‡**

   - ç”¨å¤§æ¨¡å‹ API ç”Ÿæˆ
   - ä¸€ä¸ªæ–‡æœ¬å¯¹åº”ä¸€ä¸ªå‘é‡

3. **RAG = æ£€ç´¢ + ç”Ÿæˆ**

   - æ£€ç´¢ï¼šä»å‘é‡æ•°æ®åº“æ‰¾ç›¸å…³æ–‡æ¡£
   - ç”Ÿæˆï¼šç”¨ LLM ç”Ÿæˆç­”æ¡ˆ

4. **æœ€ä½³å®è·µï¼šä¼ ç»Ÿæ•°æ®åº“ + å‘é‡æ•°æ®åº“**
   - PostgreSQL + pgvectorï¼ˆæ¨èï¼‰
   - ChromaDBï¼ˆå­¦ä¹ é˜¶æ®µï¼‰

---

### ä¸ ORM çš„ç±»æ¯”æ€»ç»“

| ORM æ¦‚å¿µ                | å‘é‡æ•°æ®åº“æ¦‚å¿µ           |
| ----------------------- | ------------------------ |
| `model User`            | `collection documents`   |
| `where: { name: 'å¼ ' }` | `queryEmbeddings: [...]` |
| `findMany()`            | `query()`                |
| `create()`              | `add()`                  |
| `update()`              | `update()`               |
| `delete()`              | `delete()`               |
| B-Tree ç´¢å¼•             | HNSW ç´¢å¼•                |
| ç²¾ç¡®åŒ¹é…                | ç›¸ä¼¼åº¦åŒ¹é…               |

---

_æ–‡æ¡£ç‰ˆæœ¬ï¼šv1.0_ _æœ€åæ›´æ–°ï¼š2026-01-30_
